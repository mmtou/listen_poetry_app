# å¬è¯—å§APP
## ç®€ä»‹
**å¬è¯—å§** æ˜¯ä¸€ä¸ªé›† è¯—è¯/è¯—äººæ¨èã€æœç´¢ã€ç®€ä»‹ã€èµæã€æœ—è¯»ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰ äºä¸€ä½“çš„è¯—è¯å…´è¶£ APPã€‚æ¶µç›–äº†ä»å¤ä»£åˆ°è¿‘ä»£çš„ 20,000 ä½è¯—äººçš„ 500,000 é¦–è¯—è¯ä½œå“ï¼Œå™äº‹è¯—ã€æŠ’æƒ…è¯—ã€é€åˆ«è¯—ã€è¾¹å¡è¯—ã€å±±æ°´ç”°å›­è¯—ã€æ€€å¤è¯—ã€æ‚¼äº¡è¯—ï¼Œå’ç‰©è¯— åº”æœ‰å°½æœ‰ğŸ˜ã€‚  
- APP ç«¯åŸºäº Google æœ€æ–°ç ”å‘çš„ Flutter UI æ¡†æ¶ï¼Œä¸€å¥—ä»£ç åº“é«˜æ•ˆæ„å»ºå¤šå¹³å°ç²¾ç¾åº”ç”¨ï¼ˆç§»åŠ¨ã€Webã€æ¡Œé¢å’ŒåµŒå…¥å¼å¹³å°ï¼‰ğŸ˜Šï¼Œé…åˆ MaterialDesign çš„è®¾è®¡é£æ ¼ å’Œ å¡ç‰‡å¼å¸ƒå±€ è®©ä½ çœ¼å‰ä¸€äº®ã€‚æ›´æœ‰å¾®ä¿¡åˆ†äº«åŠŸèƒ½ï¼Œå¥½ä¸œè¥¿å½“ç„¶è¦åˆ†äº«ğŸ‘~
  
é¡¹ç›®åœ°å€: https://github.com/mmtou/listen_poetry_app  
ä¸‹è½½ä½“éªŒ: 
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b7cfa41b1c75?w=260&h=260&f=png&s=6603)  
https://github.com/mmtou/listen_poetry_app/raw/master/demo/app-release.apk

- API ç«¯åŸºäº SpringBoot å¾®æœåŠ¡æ¶æ„ å’Œ è½»é‡çº§çš„ MySQL æ•°æ®åº“ï¼Œç»™ä½ å¸¦æ¥é«˜æ•ˆã€ç¨³å®šçš„æœåŠ¡ä½“éªŒã€‚æ›´é›†æˆäº†ç™¾åº¦çš„è¯­éŸ³åˆæˆæŠ€æœ¯ï¼Œè®©ä½ ç•…å¿«çš„äº«å—è¯—è¯å¸¦æ¥çš„ä¹è¶£ğŸ˜ã€‚


## å…ˆç¹ä¸ºå¿«
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b40f3cdd72bd?w=704&h=1396&f=png&s=232993)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b4171590400f?w=704&h=1396&f=png&s=243585)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b424418e5fc7?w=704&h=1396&f=png&s=134135)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b42901e75d58?w=704&h=1396&f=png&s=188326)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b42c69876c2c?w=704&h=1396&f=png&s=238927)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b42f0e908902?w=704&h=1396&f=png&s=163511)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b43211864e9e?w=704&h=1396&f=png&s=275281)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b4345ca158ed?w=704&h=1396&f=png&s=81032)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b43860baa88e?w=704&h=1396&f=png&s=272184)
![](https://user-gold-cdn.xitu.io/2020/2/25/1707b43a4713819d?w=704&h=1396&f=png&s=80509)

## appç«¯é¡¹ç›®ç»“æ„
```
â”œâ”€â”€ components // ç»„ä»¶
â”‚Â Â  â”œâ”€â”€ avatar.dart // å¤´åƒç»„ä»¶ï¼Œå‰æœŸæ ¹æ®åç§°ç”Ÿæˆå¯¹åº”é¢œè‰²çš„å¤´åƒ
â”‚Â Â  â”œâ”€â”€ empty.dart // ç½®ç©ºç»„ä»¶
â”‚Â Â  â”œâ”€â”€ poet.dart // è¯—äººåˆ—è¡¨
â”‚Â Â  â”œâ”€â”€ poet_item.dart // å•ä¸ªè¯—äºº
â”‚Â Â  â”œâ”€â”€ poetry.dart // è¯—è¯åˆ—è¡¨
â”‚Â Â  â”œâ”€â”€ poetry_item.dart // å•ä¸ªè¯—è¯
â”‚Â Â  â””â”€â”€ recommend.dart // æ¨èé¡µç»„ä»¶
â”œâ”€â”€ main.dart
â”œâ”€â”€ utils // å·¥å…·ç±»
â”‚Â Â  â”œâ”€â”€ common.dart // é€šç”¨å·¥å…·
â”‚Â Â  â”œâ”€â”€ constant.dart // å¸¸é‡
â”‚Â Â  â”œâ”€â”€ favorite.dart // ç‚¹çˆ±å¿ƒçš„ç®¡ç†
â”‚Â Â  â”œâ”€â”€ http.dart // ç½‘ç»œè¯·æ±‚
â””â”€â”€ views // é¡µé¢
    â”œâ”€â”€ feedback.dart // åé¦ˆ
    â”œâ”€â”€ index.dart // é¦–é¡µ
    â”œâ”€â”€ poet_detail.dart // è¯—äºº
    â”œâ”€â”€ poetry_detail.dart // è¯—è¯
    â””â”€â”€ search.dart // æœç´¢
```

## æ ¸å¿ƒä»£ç 
1. APP å¯åŠ¨æ—¶ä»æœ¬åœ°è¯»å–ç‚¹èµåˆ—è¡¨
```dart
void main() {
  if (Platform.isAndroid) {
    SystemUiOverlayStyle systemUiOverlayStyle =
        SystemUiOverlayStyle(statusBarColor: Colors.transparent);
    SystemChrome.setSystemUIOverlayStyle(systemUiOverlayStyle);
  }

  WidgetsFlutterBinding.ensureInitialized();
  run();
}

void run() async {
  await Favorite.getInstance();
  runApp(MyApp());
}
...

class Favorite {
  ...

  static Future<bool> getInstance() async {
    prefs = await SharedPreferences.getInstance();
    favorites = prefs.getStringList('favorites') ?? [];
    return true;
  }
  
  ...
}
```

2. å¤´åƒç»„ä»¶ï¼Œæ ¹æ®è¯—äººåç§°ï¼Œè®¡ç®—16ä½UTF-16ä»£ç å•å…ƒï¼Œç„¶åæ ¹æ®è§„å®šçš„é¢œè‰²æ•°ç»„é•¿åº¦å–ä½™ï¼Œå¾—åˆ°indexï¼Œä»é¢œè‰²æ•°ç»„çš„ä¸­å¾—åˆ°æŸä¸ªè‰²å€¼ï¼Œå³ä¸ºå¤´åƒçš„èƒŒæ™¯è‰²ã€‚
```dart
Widget build(BuildContext context) {
    String name = Common.getShortName(authorName);
    int index = name.codeUnitAt(0) % Constant.avatarColors.length;
    Color color = Constant.avatarColors[index];

    return InkWell(
      onTap: () {
        if (authorId != null) {
          Common.toPoetDetail(context, authorId);
        }
      },
      child: CircleAvatar(
        backgroundColor: color,
        child: Center(
          child: Text(
            name,
            style: TextStyle(
              fontWeight: FontWeight.w600,
              color: Colors.white,
            ),
          ),
        ),
      ),
    );
  }
```

3. å¾®ä¿¡åˆ†äº«ï¼Œé›†æˆ [fluwx](https://github.com/OpenFlutter/fluwx) ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œå¿«é€Ÿå®ç°å¾®ä¿¡åˆ†äº«ã€ç™»å½•ã€æ”¯ä»˜ç­‰åŠŸèƒ½ã€‚  
    1. åˆ›å»º keystoreï¼Œä¿®æ”¹ç›¸åº”é…ç½®
    2. æŸ¥çœ‹ç­¾åï¼Œæ‰§è¡Œ`keytool -list -v -keystore key.keystore`å‘½ä»¤åçš„MD5å»æ‰:è½¬ä¸ºå°å†™å³ä¸ºå¾®ä¿¡å¼€æ”¾å¹³å°çš„ç­¾åã€‚
    3. ç™»å½•å¾®ä¿¡å¼€æ”¾å¹³å°åˆ›å»ºåº”ç”¨ï¼Œå¡«å†™åŒ…åã€ç­¾åç­‰ä¿¡æ¯
    4. 
    ```dart
    fluwx.registerWxApi(
        appId: "xxxx",
        universalLink: "xxxx");
    fluwx.shareToWeChat(WeChatShareTextModel(
        text: content,
        transaction: "transaction}",
        scene: WeChatScene.SESSION));
    ```
> è¯·ç§»æ­¥ https://flutterchina.club/android-release/#appç­¾å æŸ¥çœ‹ç­¾åé…ç½® 

4. `http.dart`å•ä¾‹æ¨¡å¼ï¼Œå‡å°‘èµ„æºæµªè´¹
```dart
import 'package:bot_toast/bot_toast.dart';
import 'package:dio/dio.dart';

import './constant.dart';

class Http {
  Dio _dio;

  // å·¥å‚æ¨¡å¼
  factory Http() => _getInstance();

  static Http get instance => _getInstance();
  static Http _instance;

  Http._internal() {
    // åˆå§‹åŒ–

    if (_dio == null) {
      _dio = Dio(
        BaseOptions(
            baseUrl: Constant.host,
            connectTimeout: 10000,
            receiveTimeout: 6000,
            headers: {'Content-Type': 'application/json'}),
      );

      _dio.interceptors
          .add(InterceptorsWrapper(onRequest: (RequestOptions options) async {
        BotToast.showLoading();
        return options; //continue
      }, onResponse: (Response response) async {
        BotToast.closeAllLoading();
        var data = response.data;
        if (!data['success']) {
          BotToast.showText(text: data['message']);
          throw (data['message']);
        }
        return response.data['result']; // continue
      }, onError: (DioError e) async {
        BotToast.closeAllLoading();
        if ('DioErrorType.DEFAULT' == e.type.toString()) {
          BotToast.showText(text: e.error);
        } else {
          BotToast.showText(text: 'æœåŠ¡å™¨å¼‚å¸¸');
        }
        // Do something with response error
        return e; //continue
      }));
    }
  }

  static Http _getInstance() {
    if (_instance == null) {
      _instance = Http._internal();
    }
    return _instance;
  }

  Future get(uri, {queryParameters}) async {
    try {
      Response response = await _dio.get(uri, queryParameters: queryParameters);
      print(response);
      return response.data;
    } catch (e) {
      print(e);
    }
  }

  Future post(uri, {json}) async {
    try {
      Response response = await _dio.post(uri, data: json);
      return response.data;
    } catch (e) {
      print(e);
    }
  }
}
```

5. ä½¿ç”¨`TabView`æ—¶ï¼Œé¿å…é¡µé¢é‡ç»˜ï¼Œé€ æˆèµ„æºæµªè´¹å’Œä½“éªŒä¸‹é™;å­ç»„ä»¶é›†æˆ`AutomaticKeepAliveClientMixin`å®ç°ç¼“å­˜ç­–ç•¥ï¼Œä¸”åœ¨`build`ä¸­åŠ å…¥`super.build(context);`
```
class Poetry extends StatefulWidget {
  @override
  _PoetryState createState() => _PoetryState();
}

class _PoetryState extends State<Poetry> with AutomaticKeepAliveClientMixin {
  List list;
  int pageNum = 1;

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return EasyRefresh(
      header:
          BezierCircleHeader(backgroundColor: Theme.of(context).primaryColor),
      footer:
          BezierBounceFooter(backgroundColor: Theme.of(context).primaryColor),
      onRefresh: () => refresh(),
      onLoad: () => onLoad(),
      child: this.list == null
          ? Empty('æš‚æ— æ•°æ®~')
          : ListView.separated(
              padding: EdgeInsets.all(16),
              itemCount: this.list.length,
              separatorBuilder: (BuildContext context, int index) => Container(
                    height: 12,
                  ),
              itemBuilder: (BuildContext context, int index) {
                var item = this.list[index];
                return PoetryItem(item);
              }),
    );
  }

  refresh() async {
    this.pageNum = 1;
    this.list = [];
    await this.getList();
    return true;
  }

  onLoad() async {
    pageNum += 1;
    await this.getList();
    return true;
  }

  // è¯—è¯åˆ—è¡¨
  getList() async {
    var data = await Http().get('/poetry/list?pageNum=$pageNum');
    if (data != null) {
      List list = data['list'];
      this.list = this.list ?? [];
      setState(() {
        this.list.addAll(list);
      });
    }
  }

  @override
  void initState() {
    super.initState();
    this.getList();
  }

  @override
  bool get wantKeepAlive => true;
```

5. `InkWell`ç»„ä»¶å¯ä»¥å®ç°ç‚¹å‡»åçš„æ³¢çº¹åé¦ˆæ•ˆæœï¼Œä½†æ˜¯`InkWell`çš„childä¸èƒ½è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¸ç„¶ä¼šè¦†ç›–æ‰æ³¢çº¹çš„æ•ˆæœã€‚éœ€è¦ä½ åˆéœ€è¦èƒŒæ™¯è‰²æ€ä¹ˆåŠå‘¢ï¼Ÿå¯ä»¥åœ¨`InkWell`ä¸ŠåŒ…ä¸€å±‚`Ink`ã€‚
```dart
Ink(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(8),
      ),
      child: InkWell(
        onTap: () => Common.toPoetryDetail(context, widget.poetry),
        child: Container(
          padding: EdgeInsets.all(12),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      )
    );
```

## åŠŸèƒ½
- [x] æ¨è
- [x] å¹¿åœº
- [x] è¯—äºº
- [x] è¯—è¯è¯¦æƒ…
- [x] è¯—äººè¯¦æƒ…
- [x] å¾®ä¿¡åˆ†äº«
- [x] æœç´¢
- [ ] è¯—è¯æœ—è¯»
- [ ] ç™»å½•

## æœ€å
æœªå®Œå¾…ç»­~


![](https://user-gold-cdn.xitu.io/2020/2/25/1707b88edce6c412?w=258&h=314&f=png&s=39606)

**æ„¿ä½ èµ°å‡ºåŠç”Ÿï¼Œå½’æ¥ä»æ˜¯å°‘å¹´ã€‚**
